{{ define "main" }}
    {{ .Content }}

    <div class="planner"></div>
    <script>
        const TOTAL_GROUPS = 10
        const CHARACTERS_PER_GROUP = 5
        const PLANNER = document.querySelector('.planner')
        const PAGE_HEADER = document.querySelector('h1')
        const ROLES = ["Melee DPS", "Ranged DPS", "Tank", "Healer"].sort()
        const WEAPON_TYPES = ["Sword & Shield", 'Bow', 'Great Axe', 'War Hammer', 'Musket', 'Spear', 'Hatchet', 'Rapier', 'Life Staff', 'Fire Staff', 'Ice Gauntlet', 'Void Gauntlet'].sort()
        const TANK_WEAPONS = ['Sword & Shield']
        const MELEE_WEAPONS = ['Great Axe', 'War Hammer', 'Spear', 'Hatchet', 'Rapier'].sort()
        const RANGED_WEAPONS = ['Bow', 'Musket', 'Fire Staff', 'Ice Gauntlet', 'Void Gauntlet', 'Hatchet'].sort()
        const HEALER_WEAPONS = ['Life Staff']

        class Planner {
            id = ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            )
            groups = []

            constructor(name) {
                this.name = name
            }
        }

        class Group {
            characters = []

            constructor(description) {
                this.description = description
            }
        }

        class Character {
            constructor(primaryWeapon, secondaryWeapon) {
                if (TANK_WEAPONS.includes(primaryWeapon) || TANK_WEAPONS.includes(secondaryWeapon)) {
                    this.role = 'Tank'
                } else if (HEALER_WEAPONS.includes(primaryWeapon) || HEALER_WEAPONS.includes(secondaryWeapon)) {
                    this.role = 'Healer'
                } else if (RANGED_WEAPONS.includes(primaryWeapon) || RANGED_WEAPONS.includes(secondaryWeapon)) {
                    this.role = 'Ranged DPS'
                } else {
                    this.role = 'Melee DPS'
                }
                this.name = 'Example ' + this.role
                this.primaryWeapon = WEAPON_TYPES.find(w => w === primaryWeapon)
                this.secondaryWeapon = WEAPON_TYPES.find(w => w === secondaryWeapon)
            }
        }

        function trimString(string) {
            return string.replace(/^\s+|\s+$/g, '')
        }

        function setDocumentTitle(planner) {
            document.title = planner.name + ' | Planner | New World Invasion Guide'
        }

        function renderPlanner(planner) {
            PAGE_HEADER.innerText = planner.name
            planner.groups.forEach((group, groupIndex) => {
                const groupContainer = document.createElement('div')
                groupContainer.classList.add('planner__group')
                // Append the group container.
                PLANNER.appendChild(groupContainer)

                const groupHeader = document.createElement('h2')
                groupHeader.innerText = 'Group ' + (groupIndex + 1).toString()
                groupHeader.classList.add('planner__group__header')
                // Append the group header.
                groupContainer.appendChild(groupHeader)

                const groupDescription = document.createElement('h3')
                groupDescription.innerText = group.description
                groupDescription.classList.add('planner__group__description')
                groupDescription.contentEditable = 'true'
                // Append the group description.
                groupContainer.appendChild(groupDescription)

                const groupCharacterContainer = document.createElement('div')
                groupCharacterContainer.classList.add('planner__group__characters')
                // Append the character container.
                groupContainer.appendChild(groupCharacterContainer)

                group.characters.forEach(character => {
                    const characterContainer = document.createElement('div')
                    characterContainer.classList.add('planner__group__character')

                    const characterRole = document.createElement('img')
                    characterRole.classList.add('planner__group__character__role')

                    switch (character.role) {
                        case 'Tank':
                            characterContainer.classList.add('planner__group__character--tank')
                            characterRole.src = 'https://cdn.nwdb.info/db/images/live/v2/icons/abilities/swordability6.png'
                            characterRole.classList.add('planner__group__character__role--tank')
                            break
                        case 'Melee DPS':
                            characterContainer.classList.add('planner__group__character--melee')
                            characterRole.src = 'https://cdn.nwdb.info/db/images/live/v2/icons/abilities/hatchetability4.png'
                            characterRole.classList.add('planner__group__character__role--melee')
                            break
                        case 'Healer':
                            characterContainer.classList.add('planner__group__character--healer')
                            characterRole.src = 'https://cdn.nwdb.info/db/images/live/v2/icons/abilities/lifestaffability3.png'
                            characterRole.classList.add('planner__group__character__role--healer')
                            break
                        default:
                            characterContainer.classList.add('planner__group__character--ranged')
                            characterRole.src = 'https://cdn.nwdb.info/db/images/live/v2/icons/abilities/bowability2.png'
                            characterRole.alt = 'Ranged DPS'
                            characterRole.classList.add('planner__group__character__role--ranged')
                    }
                    characterRole.alt = character.role
                    characterRole.title = character.role

                    const characterNameRole = document.createElement('div')
                    characterNameRole.classList.add('planner__group__character__name')

                    const characterName = document.createElement('div')
                    characterName.innerText = character.name.toString()

                    const characterWeapons = document.createElement('div')
                    characterWeapons.classList.add('planner__group__character__weapons')

                    const characterPrimaryWeapon = document.createElement('select')
                    characterPrimaryWeapon.innerText = character.primaryWeapon.toString()
                    characterPrimaryWeapon.classList.add('planner__group__character__weapon')

                    const characterSecondaryWeapon = document.createElement('select')
                    characterSecondaryWeapon.innerText = character.secondaryWeapon.toString()
                    characterSecondaryWeapon.classList.add('planner__group__character__weapon')

                    WEAPON_TYPES.forEach(wt => {
                        const primaryEl = document.createElement('option')
                        primaryEl.value = wt
                        primaryEl.innerText = wt
                        characterPrimaryWeapon.appendChild(primaryEl)

                        if (wt === character.primaryWeapon) {
                            primaryEl.selected = true
                        }

                        const secondaryEl = document.createElement('option')
                        secondaryEl.value = wt
                        secondaryEl.innerText = wt
                        characterSecondaryWeapon.appendChild(secondaryEl)

                        if (wt === character.secondaryWeapon) {
                            secondaryEl.selected = true
                        }
                    })

                    // Append character information to the character container.
                    characterContainer.appendChild(characterNameRole)
                    characterNameRole.appendChild(characterRole)
                    characterNameRole.appendChild(characterName)
                    characterContainer.appendChild(characterWeapons)
                    characterWeapons.appendChild(characterPrimaryWeapon)
                    characterWeapons.appendChild(characterSecondaryWeapon)

                    // Append this character to the character container.
                    groupCharacterContainer.appendChild(characterContainer)
                })
            })
        }

        function getLocalPlanners() {
            return JSON.parse(localStorage.getItem('planners'))
        }

        function getPlannerFromId(id) {
            const planners = getLocalPlanners()
            if (planners.length) {
                return planners.find(p => p.id === id)
            }
            return undefined
        }

        function getCurrentPagePlanner() {
            return getPlannerFromId(new URLSearchParams(window.location.search).get('id'))
        }

        function savePlanner(planner) {
            const planners = getLocalPlanners()
            let localPlanner = planners.find(p => p.id === planner.id)
            planners[planners.indexOf(localPlanner)] = planner
            localStorage.setItem('planners', JSON.stringify(planners))
        }

        function updatePlannerName(planner) {
            let text = PAGE_HEADER.innerText
            if (text) {
                text = trimString(text)
                planner.name = text
                savePlanner(planner)
            } else {
                PAGE_HEADER.innerText = planner.name
            }
            setDocumentTitle(planner)
        }

        function updateGroupDescription(index, text) {
            const planner = getCurrentPagePlanner()
            text = trimString(text)
            planner.groups[index].description = text
            savePlanner(planner)
        }

        function init() {
            const planners = getLocalPlanners()
            console.log(planners)
            if (!planners || !planners.length) {
                const planners = []
                // Initialize a new planner of one isn't found yet.
                const newPlanner = new Planner('My Example Invasion Planner')
                for (let i = 0; i < TOTAL_GROUPS; i++) {
                    const group = new Group('Group ' + (i + 1).toString() + ' Description')
                    for (let c = 0; c < CHARACTERS_PER_GROUP; c++) {
                        group.characters.push(new Character('Spear', 'Bow'))
                    }
                    newPlanner.groups.push(group)
                }
                planners.push(newPlanner)
                localStorage.setItem('planners', JSON.stringify(planners))
                // Redirect to the new planner.
                window.location.assign('/planner/?id=' + newPlanner.id)
            }

            // Get the planner from the ID.
            const planner = getCurrentPagePlanner()
            renderPlanner(planner)

            // Allow the user to edit the planner name.
            PAGE_HEADER.contentEditable = 'true'
            PAGE_HEADER.spellcheck = false
            PAGE_HEADER.addEventListener('keydown', e => {
                if (e.code === 'Enter') {
                    PAGE_HEADER.blur()
                }
            })
            PAGE_HEADER.addEventListener('blur', () => {
                updatePlannerName(planner)
            })

            // Allow the user to edit group descriptions.
            document.querySelectorAll('.planner__group__description').forEach((gd, index) => {
                gd.addEventListener('keydown', e => {
                    if (e.code === 'Enter') {
                        gd.blur()
                    }
                })
                gd.addEventListener('blur', e => {
                    updateGroupDescription(index, e.target.innerText)
                })
            })
        }

        init()
    </script>
{{ end }}